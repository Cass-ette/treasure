<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>仪表盘 - 投资管理系统</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f5f5f5; }
        /* 饼图容器样式 */
        #positionPieChart {
            height: 400px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 15px; }
        h1 { color: #333; margin: 0; }
        .logout { background-color: #f44336; color: white; padding: 10px 20px; border: none; border-radius: 3px; cursor: pointer; text-decoration: none; }
        .logout:hover { background-color: #d32f2f; }
        .manage-funds { background-color: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 3px; cursor: pointer; text-decoration: none; margin-right: 10px; }
        .manage-funds:hover { background-color: #3e8e41; }
        .toggle-container { display: flex; align-items: center; gap: 10px; }
        .toggle-btn { padding: 8px 16px; border: none; border-radius: 3px; cursor: pointer; background-color: #2196F3; color: white; }
        .toggle-btn:hover { background-color: #0b7dda; }
        .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background-color: white; padding: 20px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .card h3 { color: #666; margin: 0 0 10px 0; }
        .card .value { font-size: 24px; font-weight: bold; color: #333; }
        .card .yield-rate { font-size: 18px; margin-top: 5px; }
        .profit { color: #f44336; }
        .loss { color: #4CAF50; }
        .positions { background-color: white; padding: 20px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-top: 30px; }
        .positions h3 { color: #333; margin-top: 0; }
        .sub-accounts { background-color: white; padding: 20px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-top: 30px; }
        .sub-accounts h3 { color: #333; margin-top: 0; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f2f2f2; }
        /* 国际模式样式 */
        body.international-mode .profit { color: #4CAF50; }
        body.international-mode .loss { color: #f44336; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="main-title">投资管理仪表盘</h1>
            <div class="toggle-container">
                <span id="color-mode-text">中国模式 (红涨)</span>
                <button id="toggle-color-mode" class="toggle-btn">切换至国际模式</button>
            </div>
            {% if current_user.is_main_account %}
            <a href="{{ url_for('manage_funds') }}" id="manage-funds-link" class="manage-funds">管理基金</a>
            <a href="{{ url_for('crawl_fund_nav') }}" id="crawl-fund-nav-link" class="manage-funds">爬取基金净值</a>
            <a href="{{ url_for('manage_positions') }}" id="manage-positions-link" class="manage-funds">管理持仓</a>
            {% endif %}
            <a href="{{ url_for('upload_image') }}" id="image-processing-link" class="manage-funds">图片识别</a>
            <a href="{{ url_for('logout') }}" id="logout-link" class="logout">退出登录</a>
        </div>
        
        <div class="cards">
            <div class="card">
                <h3 id="principal-title">总本金</h3>
                <div class="value">¥{{ "%.2f"|format(total_principal) }}</div>
        </div>
        <div class="card">
            <h3 id="market-value-title">总市值</h3>
            <div class="value">¥{{ "%.2f"|format(total_value) }}</div>
        </div>
        <div class="card">
            <h3 id="profit-title">总盈亏</h3>
            <div class="value {{ 'profit' if total_profit > 0 else 'loss' }}">¥{{ "%.2f"|format(total_profit) }}</div>
            <div class="yield-rate {{ 'profit' if total_profit > 0 else 'loss' }}"><span id="yield-rate-label">收益率: </span>{{ "%.2f"|format((total_profit/total_principal)*100 if total_principal > 0 else 0) }}%</div>
            </div>
        </div>
        
        <div class="positions">
            <h3 id="positions-title">持仓概览</h3>
            <!-- 饼图容器 -->
            <div style="margin-bottom: 30px; max-width: 500px; margin-left: auto; margin-right: auto;">
                <canvas id="positionPieChart"></canvas>
            </div>
            <table id="positions-table">
                <tr>
                    <th id="fund-name-header">基金名称</th>
                    <th id="cost-header">成本</th>
                    <th id="value-header" style="cursor: pointer;">市值 <span id="sort-icon" style="font-size: 0.8em;">↓</span></th>
                    <th id="profit-header">盈亏</th>
                    <th id="return-header">收益率</th>
                    <th id="proportion-header">占比</th>
                </tr>
                {% if current_user.positions %}
                    {% for position in current_user.positions %}
                        {% if position.fund and position.fund.latest_nav %}
                            <tr>
                                <td>{{ position.fund.name }}</td>
                                <td>¥{{ "%.2f"|format(position.shares * position.cost_price) }}</td>
                                <td>¥{{ "%.2f"|format(position.shares * position.fund.latest_nav) }}</td>
                                <td class="{{ 'profit' if (position.shares * position.fund.latest_nav) > (position.shares * position.cost_price) else 'loss' }}">¥{{ "%.2f"|format(position.shares * position.fund.latest_nav - position.shares * position.cost_price) }}</td>
                                <td class="{{ 'profit' if (position.shares * position.fund.latest_nav) > (position.shares * position.cost_price) else 'loss' }}">{{ "%.2f"|format(((position.fund.latest_nav - position.cost_price) / position.cost_price)*100 if position.cost_price > 0 else 0) }}%</td>
                                <td>{{ "%.2f"|format(((position.shares * position.fund.latest_nav) / total_value)*100 if total_value > 0 else 0) }}%</td>
                            </tr>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="6">暂无持仓数据</td>
                    </tr>
                {% endif %}

            </table>
        </div>
        
        <div class="sub-accounts">
            <h3 id="sub-accounts-title">次级账户管理</h3>
            <table>
                <tr>
                    <th id="username-header">用户名</th>
                    <th id="sub-principal-header">本金</th>
                    <th id="status-header">状态</th>
                    <th id="action-header">操作</th>
                </tr>
                {% if current_user.is_main_account and sub_accounts %}
                    {% for account in sub_accounts %}
                        <tr>
                            <td>{{ account.username }}</td>
                            <td>¥{{ "%.2f"|format(account.principal) }}</td>
                            <td class="status-text">活跃</td>
                            <td>
                                <button onclick="showEditPrincipalModal({{ account.id }}, '{{ account.username }}', {{ account.principal }})" class="toggle-btn">修改本金</button>
                            </td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="4">暂无次级账户数据</td>
                    </tr>
                {% endif %}
            </table>
        </div>
        
        <!-- 修改本金模态框 -->
        <div id="editPrincipalModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
            <div style="background-color: white; margin: 10% auto; padding: 20px; border-radius: 5px; max-width: 500px;">
                <h3 id="modal-title">修改次级账户本金</h3>
                <form id="editPrincipalForm" method="POST" action="{{ url_for('update_sub_account_principal') }}">
                    <input type="hidden" name="account_id" id="account_id">
                    <div style="margin-bottom: 15px;">
                        <label for="account_username">用户名:</label>
                        <input type="text" id="account_username" disabled style="width: 100%; padding: 8px; margin-top: 5px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="principal">新本金金额:</label>
                        <input type="number" step="0.01" min="0" name="principal" id="principal" required style="width: 100%; padding: 8px; margin-top: 5px;">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" class="toggle-btn">确认修改</button>
                        <button type="button" onclick="hideEditPrincipalModal()" class="logout">取消</button>
                    </div>
                    <!-- CSRF Token -->
                    {{ form.csrf_token if form else '' }}
                </form>
            </div>
        </div>
    </div>
    <script>
        // 涨跌颜色模式切换功能
        document.addEventListener('DOMContentLoaded', function() {
            const toggleBtn = document.getElementById('toggle-color-mode');
            const modeText = document.getElementById('color-mode-text');
            const body = document.body;
            const pageTitle = document.title;
            
            // 所有需要翻译的元素
            const elements = {
                mainTitle: document.getElementById('main-title'),
                logoutLink: document.getElementById('logout-link'),
                manageFundsLink: document.getElementById('manage-funds-link'),
                crawlFundNavLink: document.getElementById('crawl-fund-nav-link'),
                managePositionsLink: document.getElementById('manage-positions-link'),
                imageProcessingLink: document.getElementById('image-processing-link'),
                principalTitle: document.getElementById('principal-title'),
                marketValueTitle: document.getElementById('market-value-title'),
                profitTitle: document.getElementById('profit-title'),
                yieldRateLabel: document.getElementById('yield-rate-label'),
                positionsTitle: document.getElementById('positions-title'),
                fundNameHeader: document.getElementById('fund-name-header'),
                costHeader: document.getElementById('cost-header'),
                valueHeader: document.getElementById('value-header'),
                profitHeader: document.getElementById('profit-header'),
                returnHeader: document.getElementById('return-header'),
                proportionHeader: document.getElementById('proportion-header'),
                subAccountsTitle: document.getElementById('sub-accounts-title'),
                usernameHeader: document.getElementById('username-header'),
                subPrincipalHeader: document.getElementById('sub-principal-header'),
                statusHeader: document.getElementById('status-header'),
                statusTexts: document.querySelectorAll('.status-text')
            };
            
            // 中英文翻译映射
            const translations = {
                '投资管理仪表盘': 'Investment Management Dashboard',
                '退出登录': 'Logout',
                '管理基金': 'Manage Funds',
                '爬取基金净值': 'Crawl Fund NAV',
                '管理持仓': 'Manage Positions',
                '图片识别': 'Image Recognition',
                '总本金': 'Total Principal',
                '总市值': 'Total Market Value',
                '总盈亏': 'Total Profit/Loss',
                '收益率: ': 'Yield Rate: ',
                '持仓概览': 'Position Overview',
                '基金名称': 'Fund Name',
                '成本': 'Cost',
                '市值': 'Market Value',
                '盈亏': 'Profit/Loss',
                '收益率': 'Yield Rate',
                '占比': 'Proportion',
                '次级账户管理': 'Sub-account Management',
                '用户名': 'Username',
                '本金': 'Principal',
                '状态': 'Status',
                '操作': 'Action',
                '活跃': 'Active',
                '仪表盘 - 投资管理系统': 'Dashboard - Investment Management System'
            };
            
            // 初始化持仓饼图
            function initPositionPieChart() {
                const ctx = document.getElementById('positionPieChart').getContext('2d');
                const fundNames = {{ fund_names | tojson }};
                const fundValues = {{ fund_values | tojson }};
                
                // 生成随机颜色
                const backgroundColors = [];
                const borderColors = [];
                for (let i = 0; i < fundNames.length; i++) {
                    const r = Math.floor(Math.random() * 255);
                    const g = Math.floor(Math.random() * 255);
                    const b = Math.floor(Math.random() * 255);
                    backgroundColors.push(`rgba(${r}, ${g}, ${b}, 0.6)`);
                    borderColors.push(`rgba(${r}, ${g}, ${b}, 1)`);
                }
                
                if (fundNames.length > 0 && fundValues.length > 0) {
                    new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: fundNames,
                            datasets: [{
                                label: '市值占比',
                                data: fundValues,
                                backgroundColor: backgroundColors,
                                borderColor: borderColors,
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'right',
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.raw || 0;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = ((value / total) * 100).toFixed(2);
                                            return `${label}: ¥${value.toFixed(4)} (${percentage}%)`;
                                        }
                                    }
                                },
                                title: {
                                    display: true,
                                    text: '持仓市值占比分析'
                                }
                            }
                        }
                    });
                }
            }

            // 页面加载完成后初始化饼图
            window.addEventListener('DOMContentLoaded', function() {
                // 等待数据渲染完成
                setTimeout(() => {
                    initPositionPieChart();
                }, 100);
            });

            // 按市值从大到小排序持仓表格
            function sortPositionsTable() {
                const table = document.getElementById('positions-table');
                const tbody = table.getElementsByTagName('tbody')[0];
                const rows = Array.from(tbody.getElementsByTagName('tr'));
                
                // 按市值从大到小排序
                rows.sort((a, b) => {
                    const valueA = parseFloat(a.cells[2].textContent.replace('¥', '').replace(',', ''));
                    const valueB = parseFloat(b.cells[2].textContent.replace('¥', '').replace(',', ''));
                    return valueB - valueA;
                });
                
                // 重新排列表格行
                rows.forEach(row => tbody.appendChild(row));
            }
            
            // 页面加载完成后自动排序
            window.addEventListener('DOMContentLoaded', function() {
                // 等待表格数据渲染完成
                setTimeout(() => {
                    sortPositionsTable();
                }, 100);
            });
            
            // 为市值表头添加点击排序功能
            document.getElementById('value-header').addEventListener('click', sortPositionsTable);
            
            // 切换语言的函数
            function toggleLanguage(isInternational) {
                if (isInternational) {
                    // 切换到英文
                    document.title = translations[pageTitle];
                    elements.mainTitle.textContent = translations[elements.mainTitle.textContent];
                    if (elements.logoutLink) elements.logoutLink.textContent = translations[elements.logoutLink.textContent];
                    if (elements.manageFundsLink) elements.manageFundsLink.textContent = translations[elements.manageFundsLink.textContent];
                    if (elements.crawlFundNavLink) elements.crawlFundNavLink.textContent = translations[elements.crawlFundNavLink.textContent];
                    if (elements.managePositionsLink) elements.managePositionsLink.textContent = translations[elements.managePositionsLink.textContent];
                    if (elements.imageProcessingLink) elements.imageProcessingLink.textContent = translations[elements.imageProcessingLink.textContent];
                    elements.principalTitle.textContent = translations[elements.principalTitle.textContent];
                    elements.marketValueTitle.textContent = translations[elements.marketValueTitle.textContent];
                    elements.profitTitle.textContent = translations[elements.profitTitle.textContent];
                    elements.yieldRateLabel.textContent = translations[elements.yieldRateLabel.textContent];
                    elements.positionsTitle.textContent = translations[elements.positionsTitle.textContent];
                    elements.fundNameHeader.textContent = translations[elements.fundNameHeader.textContent];
                    elements.costHeader.textContent = translations[elements.costHeader.textContent];
                    // 特殊处理市值表头，保留排序图标
                    const sortIcon = document.getElementById('sort-icon');
                    elements.valueHeader.textContent = translations['市值'] + ' ';
                    elements.valueHeader.appendChild(sortIcon);
                    elements.profitHeader.textContent = translations[elements.profitHeader.textContent];
                    elements.returnHeader.textContent = translations[elements.returnHeader.textContent];
                    elements.proportionHeader.textContent = translations[elements.proportionHeader.textContent];
                    elements.subAccountsTitle.textContent = translations[elements.subAccountsTitle.textContent];
                    elements.usernameHeader.textContent = translations[elements.usernameHeader.textContent];
                    elements.subPrincipalHeader.textContent = translations[elements.subPrincipalHeader.textContent];
                    elements.statusHeader.textContent = translations[elements.statusHeader.textContent];
                    
                    elements.statusTexts.forEach(element => {
                        element.textContent = translations[element.textContent];
                    });
                } else {
                    // 切换回中文
                    document.title = pageTitle;
                    elements.mainTitle.textContent = '投资管理仪表盘';
                    if (elements.logoutLink) elements.logoutLink.textContent = '退出登录';
                    if (elements.manageFundsLink) elements.manageFundsLink.textContent = '管理基金';
                    if (elements.crawlFundNavLink) elements.crawlFundNavLink.textContent = '爬取基金净值';
                    if (elements.managePositionsLink) elements.managePositionsLink.textContent = '管理持仓';
                    if (elements.imageProcessingLink) elements.imageProcessingLink.textContent = '图片识别';
                    elements.principalTitle.textContent = '总本金';
                    elements.marketValueTitle.textContent = '总市值';
                    elements.profitTitle.textContent = '总盈亏';
                    elements.yieldRateLabel.textContent = '收益率: ';
                    elements.positionsTitle.textContent = '持仓概览';
                    elements.fundNameHeader.textContent = '基金名称';
                    elements.costHeader.textContent = '成本';
                    // 特殊处理市值表头，保留排序图标
                    const sortIcon = document.getElementById('sort-icon');
                    elements.valueHeader.textContent = '市值 ';
                    elements.valueHeader.appendChild(sortIcon);
                    elements.profitHeader.textContent = '盈亏';
                    elements.returnHeader.textContent = '收益率';
                    elements.proportionHeader.textContent = '占比';
                    elements.subAccountsTitle.textContent = '次级账户管理';
                    elements.usernameHeader.textContent = '用户名';
                    elements.subPrincipalHeader.textContent = '本金';
                    elements.statusHeader.textContent = '状态';
                    
                    elements.statusTexts.forEach(element => {
                        element.textContent = '活跃';
                    });
                }
            }
            
            toggleBtn.addEventListener('click', function() {
                if (body.classList.contains('international-mode')) {
                    // 切换到中国模式
                    body.classList.remove('international-mode');
                    toggleBtn.textContent = '切换至国际模式 / Switch to International Mode';
                    modeText.textContent = '中国模式 (红涨)';
                    toggleLanguage(false);
                } else {
                    // 切换到国际模式
                    body.classList.add('international-mode');
                    toggleBtn.textContent = '切换到中文模式 / Switch to Chinese Mode';
                    modeText.textContent = 'International Mode (Green Up)';
                    toggleLanguage(true);
                }
            });
        });
        
        // 显示修改本金模态框
        window.showEditPrincipalModal = function(accountId, username, currentPrincipal) {
            const modal = document.getElementById('editPrincipalModal');
            const accountIdInput = document.getElementById('account_id');
            const accountUsernameInput = document.getElementById('account_username');
            const principalInput = document.getElementById('principal');
            
            accountIdInput.value = accountId;
            accountUsernameInput.value = username;
            principalInput.value = currentPrincipal;
            
            modal.style.display = 'block';
        }
        
        // 隐藏修改本金模态框
        window.hideEditPrincipalModal = function() {
            const modal = document.getElementById('editPrincipalModal');
            modal.style.display = 'none';
        }
        
        // 点击模态框外部关闭
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('editPrincipalModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        })
    </script>
</body>
</html>